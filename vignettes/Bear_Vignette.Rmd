---
title: "rovquantR : a R package to reproduce RovQuant analyses"
subtitle : "Norwegian bear population"
author: "Pierre Dupont"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
bibliography: references.bib  
vignette: >
  %\VignetteIndexEntry{Wolverine Example}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  markdown: 
    wrap: sentence
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

Large carnivores are rare, elusive, and controversial.
Their populations are difficult to monitor and manage.
For over 10 years, Swedish and Norwegian authorities have been accumulating monitoring data in [**Rovbase**](https://rovbase.no/), an international large carnivore database.
Today, the database contains records from thousands of non-invasive genetic samples, observations, and dead recoveries of bears, wolves, and wolverines, collected by managers, researchers, hunters, and other members of the public in Scandinavia.

Since 2017, project [**RovQuant**](https://www.nmbu.no/en/research/projects/rovquant) from the Applied Quantitative Ecology Group ([**AQEG**](https://www.nmbu.no/en/research/groups/applied-quantitative-ecology-group-aqeg)) has developed and tested statistical methods for the analysis of this unique database.
The goals of this international research project are to:

1.  **Estimate carnivore population sizes and map carnivore densities.** RovQuant provides population size estimates for wolves, bears, and wolverines throughout Norway and Swede annually.
    RovQuant also generates carnivore density surfaces - maps of the density of wolverines, wolves, and bears - across Norway and Sweden.
    These maps and the underlying data are freely available.

2.  **Estimate population vital rates.** Population vital rates drive the change in wildlife population over time.
    These dynamics are the result of a combination of mortality, recruitment, immigration, and emigration.
    Monitoring conducted over multiple years allows RovQuant to estimate vital rates of large carnivores in Scandinavia.
    These estimates, in turn, are a prerequisite for population forecasting.

3.  **Further develop monitoring protocols**.
    RovQuant aims to help authorities develop protocols for the cost-efficient collection of non-invasive sampling data.
    Properly designed and executed monitoring leads to reliable data, and reliable data are a pre-requisite for producing trustworthy estimates and conclusions.
    This is particularly important when scientific results inform policy decisions and wildlife management.
    This work is done in collaboration with those leading the data collection effort in Scandinavia, including *Rovdata*, *Wildlife Damage Centre (VSC),* *The Swedish Museum of Natural History (NRM)*, and other organizations.

4.  **Collaborate with managers.** The project results are published annually in technical reports.
    In addition, we attend meetings and workshops to ensure that RovQuant remains up-to-date on current and emerging challenges in large carnivore monitoring and management.

The methods developed during project RovQuant are based on the Spatial Capture-Recapture (SCR) methodology and involve large-scale analysis of individual-based datasets in a Bayesian framework.
Spatial Capture-Recapture (SCR) methods use the spatial information contained in individual detections, for example, DNA samples left behind by wildlife, to estimate the location of activity centers of all individuals in the population, including those never detected.
SCR models thus produce density estimates and density surfaces, while accounting for the fact that not all individuals are detected.
Furthermore, abundance estimates produced by SCR models take into account that animals move across the landscape and may be detected in multiple locations â€“ for example, a bear living near the Swedish-Norwegian border may contribute partially to population size estimates in both countries.
These developments were conducted in collaboration with the [**NIMBLE**](https://r-nimble.org/) development team, and led to the publication of the [**nimbleSCR**](https://cran.r-project.org/web/packages/nimbleSCR/index.html) R package, compiling a set of custom functions and distributions allowing to build custom SCR models to analyse large-scale datasets.

In addition, the **rovquantR** package has been recently developed to facilitate the reproduction of the latest analyses performed by the RovQuant team.
This vignette presents the RovQuant workflow for the analysis of the Norwegian portion of the Brown bear non-invasive genetic monitoring data using package **rovquantR**.
It consists in the Open-Population Spatial Capture-Recapture (OPSCR) analysis of the non-invasive genetic sampling and dead recovery data collected by the Norwegian authorities and made available in the transnational large carnivore database **Rovbase** as of June 2025.

# Package Installation

Before we can start the analysis, we need to make sure that the necessary ***R*** libraries are installed.
The first step is to check if ***Rtools*** is installed.
Note that ***Rtools*** is not a ***R*** package *per se* and needs to be installed separately from the [Rtools CRAN page](https://cran.r-project.org/bin/windows/Rtools/).
To check if ***Rtools*** is correctly installed, we use the function *has_rtools()* from the *pkgbuild* package.

```{r Rtools, eval = FALSE}
install.packages("pkgbuild")
library(pkgbuild)
has_rtools()
```

Once we have ensured ***Rtools*** is available, we can install and load the *nimbleSCR* package:

```{r libraries, eval = FALSE}
install.packages("nimbleSCR")
library(nimbleSCR)
```

Now, we can install the *rovquantR* package.
Because it is not yet available on CRAN, we have to install it from the GitHub repository using the *devtools* package :

```{r gitinstall, eval = FALSE}
install.packages("devtools")
library(devtools)
install_github("PierreDupont/rovquantR")
```

Alternatively, we can install it from the **.tar.gz** file that was provided:

```{r tarinstall, eval = FALSE}
install.packages( "C:/My_documents/rovquantR/rovquantR_0.1.tar.gz",
                  repos = NULL,
                  type = "source") 
```

Finally, we can load the rovquantR package and start the analysis:

```{r tarinstall, eval = FALSE}
library(rovquantR)
```

# Data Preparation

We start by loading the different ***R*** packages necessary for the analysis, and in particular the 'rovquantR' package, which contains a set of wrapper functions to facilitate the analysis.

```{r library, warning = FALSE, message = FALSE}
library(nimbleSCR)
library(rovquantR)
```

## Working Environment

Next, we need to set-up the general working environment for the analysis.
This includes the location of the raw data files (imported from RovBase) and the directory chosen for the analysis.
The first directory is called 'data.dir' and corresponds to the folder where the raw data is located.

It contains the different files necessary for the OPSCR analysis:

-   an excel file of all the brown bear DNA samples available from Rovbase

-   an excel file of all the brown bear dead recoveries available from Rovbase

-   an excel file of all large carnivore observations available from Skandobs

-   multiple spatial covariates (in the 'GIS' folder)

Note that this is NOT the working directory.
For all intent and purposes, it should be treated as a 'read-only' directory.

```{r set-up1.1, eval = FALSE, echo = FALSE}
##-- DATA DIRECTORY
##-- Directory containing the raw data necessary for the analysis
##-- (NB: This is NOT the working directory; NOTHING SHOULD BE SAVED/WRITTEN IN THIS DIRECTORY)
data.dir <- "C:/Users/pidu/AQEG Dropbox/AQEG Team Folder/RovQuant/bear/2025/Data"

##-- WORKING DIRECTORY (= main folder for the analysis)
working.dir <- "C:/Users/pidu/AQEG Dropbox/AQEG Team Folder/RovQuant/bear/2025/temp"

```

```{r set-up1.2, eval = FALSE, echo = TRUE}
data.dir <- "./Data"
```

The second directory will be used to store all the files and outputs from the analysis.

```{r set-up2.2, eval = FALSE, echo = TRUE}
working.dir <- "./BearVignette"
```

To make it easier (and more reproducible), we created the 'makeDirectories' function.
This will create a set of folders in the location specific by 'working.dir' that will later be used to store processed data, model input and output, as well as results figures and tables.

```{r set.up3, eval = FALSE}
makeDirectories(path = working.dir)
```

## Rovbase data

Before we dive in the OPSCR analysis itself, there is one more step we need to take.
The raw export from Rovbase contain variable column names and Scandinavian characters which make it cumbersome to work with in R.
We therefore rename the columns here for easier processing.

In addition, we have noted that, over the years, certain fields have been added, while others had their names changed.
For this reason, it is very difficult/impossible to automatize this process and the user has to make sure the field names below are up to date.

```{r rename_DNA, eval=FALSE}


```

## Data cleaning

Now, we clean the data.
This step involves multiples actions, such as subsetting the data to the species and period of interest for the analysis, checking individual sex assigments, etc...
In order to evaluate the cleaning procedure, the cleaing function prints out a report in .html format summarizing the content of the cleaned dataset.
This report can be found in the 'data' folder of the analysis directory, labbled with the date corresponding to the last modification date of the raw data.

```{r clean, eval = FALSE}
cleanRovbaseData( 
  species = "bear",
  years = 2020:2025,
  data.dir = data.dir,
  working.dir = working.dir,
  two.sex = TRUE,
  print.report = TRUE)

```

## Data preparation

Now that we have cleaned out the data, it is time to format it for analysis using nimbleSCR.
This process can be quite opaque and complex and this is why we have created the 'makeRovquantData' wrapper function, which encapsulates the latest data formatting scripts for the different species.

```{r make, eval = FALSE}

makeRovquantData(    
  species = "bear",
  data.dir = data.dir,
  working.dir = working.dir)


```

# Model fitting

The next step is to fit the OPSCR model to the prepared bear data using NIMBLE.
In this example, as in most cases in the RovQuant project, we fit sex-specific models.

```{r run_females1.1, eval=FALSE}

##-- List all prepared input files
inputFiles <- list.files( file.path(working.dir, "nimbleInFiles/female"),
                          full.names = T)

##-- Load the first one
load(inputFiles[1]) 

##-- Build nimble model object
model <- nimbleModel( code = modelCode,
                      constants = nimConstants,
                      inits = nimInits,
                      data = nimData,
                      check = FALSE,
                      calculate = FALSE) 
model$calculate()
cmodel <- compileNimble(model)
conf <- configureMCMC( model,
                       monitors = nimParams,
                       thin = 1,
                       monitors2 = nimParams2,
                       thin2 = 5)
Rmcmc <- buildMCMC(conf)
compiledList <- compileNimble( list(model = model,
                                    mcmc = Rmcmc),
                               showCompilerOutput = F)
Cmcmc <- compiledList$mcmc

##-- RUN NIMBLE MCMC IN SUCCESSIVE BITES
system.time(runMCMCbites( mcmc = Cmcmc,
                          bite.size = 100,
                          bite.number = 10,
                          path = file.path(working.dir,"nimbleOutfiles/female")))


```

```{r run_females1.2, eval=FALSE}
 load(system.file("extdata", "WolverineData.RData", package = "nimbleSCR"))
```

The first step when fitting a statistical model using NIMBLE is to create a model object, containing the model code, the constants/dimensions, data and initial values used in the model.

```{r run_females2, eval=FALSE}
model <- nimbleModel( code = modelCode,
                      constants = nimConstants,
                      inits = nimInits,
                      data = nimData,
                      check = FALSE,
                      calculate = FALSE) 
```

The second step is to compile the model in C++.

```{r run_females3, eval=FALSE}
cmodel <- compileNimble(model)
```

Next, we need to configure and compile the MCMC algorithm that will be used to sample posterior samples.

```{r run_females4, eval=FALSE}
conf <- configureMCMC( model,
                       monitors = nimParams,
                       thin = 1,
                       monitors2 = nimParams2,
                       thin2 = 5)
Rmcmc <- buildMCMC(conf)
compiledList <- compileNimble( list(model = model,
                                    mcmc = Rmcmc),
                               showCompilerOutput = F)
Cmcmc <- compiledList$mcmc
```

Finally, once the MCMC algorithm and the model are prepared and compiled, we can run it using the 'runMCMCbites' function.

```{r run_females5, eval=FALSE}
system.time(runMCMCbites( mcmc = Cmcmc,
                          bite.size = 100,
                          bite.number = 5,
                          path = file.path(working.dir,"nimbleOutfiles/Hunn")))

```

And now we can do the same for males:

```{r run_males, eval=FALSE}
##-- List all prepared input files
inputFiles <- list.files( file.path(working.dir, "nimbleInFiles/male"),
                         full.names = T)

##-- Load the first one
load(inputFiles[1]) 

##-- Build nimble model object
model <- nimbleModel( code = modelCode,
                      constants = nimConstants,
                      inits = nimInits,
                      data = nimData,
                      check = FALSE,
                      calculate = FALSE) 
model$calculate()

cmodel <- compileNimble(model)
conf <- configureMCMC(model,
                      monitors = nimParams,
                      thin = 1,
                      monitors2 = nimParams2,
                      thin2 = 5)
Rmcmc <- buildMCMC(conf)
compiledList <- compileNimble(list(model = model,
                                   mcmc = Rmcmc),
                              showCompilerOutput = F)
Cmcmc <- compiledList$mcmc

##-- RUN NIMBLE MCMC IN SUCCESSIVE BITES
system.time(runMCMCbites( mcmc = Cmcmc,
                          bite.size = 100,
                          bite.number = 10,
                          path = file.path(working.dir,"nimbleOutfiles/male")))
```

# Output processing

```{r process, eval=FALSE}

processRovquantOutput(   
  species = "Brown bear"
  ,
  data.dir = data.dir
  ,
  working.dir = working.dir
  ,
  nburnin = 0
  ,
  niter = 100
  ,
  extraction.res = 5000
  ,
  print.report = TRUE
  ,
  overwrite = FALSE
)

```

```{r visualize}

```
